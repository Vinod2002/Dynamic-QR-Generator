<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualivon - Dynamic Attendance QR Code</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* A simple transition for the progress bar */
        #progress-bar {
            transition: width 1s linear;
        }
        /* Custom styles for active/inactive buttons */
        .btn-active {
            background-color: #158d44; /* Qualivon Green */
            color: white;
            border-color: #158d44;
        }
        .btn-inactive {
            background-color: white;
            color: #6b7280; /* Gray-500 */
            border-color: #d1d5db; /* Gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen font-sans">

    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full m-4">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Qualivon Attendance</h1>
            <p class="text-gray-500 mt-2">Select IN or OUT to generate the correct code.</p>
        </header>

        <!-- IN/OUT Button Selector -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="btn-in" class="p-3 rounded-lg font-semibold border-2 transition-colors">
                IN
            </button>
            <button id="btn-out" class="p-3 rounded-lg font-semibold border-2 transition-colors">
                OUT
            </button>
        </div>
        
        <!-- Location Status Message -->
        <div id="location-status" class="mb-4 text-sm text-center"></div>

        <!-- Container where the QR code will be generated -->
        <div id="qrcode-container" class="flex justify-center my-8 min-h-[288px] items-center">
            <div id="qrcode" class="p-4 bg-white border rounded-lg shadow-inner"></div>
        </div>

        <!-- Display for the content of the QR code for verification -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 break-words min-h-[60px]">
            <p class="text-xs text-gray-500 font-semibold mb-1">CURRENT QR CODE VALUE</p>
            <p id="qr-content-display" class="text-sm font-mono text-gray-700"></p>
        </div>

        <!-- Countdown timer and progress bar -->
        <div class="mt-8">
            <p class="text-gray-600">New code in: <span id="countdown" class="font-bold">1:00</span></p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                <div id="progress-bar" class="bg-green-600 h-2.5 rounded-full" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const UPDATE_INTERVAL_MINUTES = 1; // Set the update interval in minutes
        const UPDATE_INTERVAL_MS = UPDATE_INTERVAL_MINUTES * 60 * 1000;
        let currentMode = 'IN'; // Can be 'IN' or 'OUT'

        // --- DOM ELEMENTS ---
        const qrcodeContainer = document.getElementById('qrcode');
        const contentDisplay = document.getElementById('qr-content-display');
        const countdownDisplay = document.getElementById('countdown');
        const progressBar = document.getElementById('progress-bar');
        const btnIn = document.getElementById('btn-in');
        const btnOut = document.getElementById('btn-out');
        const locationStatusEl = document.getElementById('location-status');
        
        let qrCodeInstance = null;
        let countdownIntervalId = null;

        /**
         * Gets the user's current GPS location.
         * @returns {Promise<GeolocationPosition>} A promise that resolves with the GeolocationPosition object or rejects with an error.
         */
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject("Geolocation is not supported by your browser.");
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position),
                    () => reject("Location access denied. Please grant permission.")
                );
            });
        }

        /**
         * Gets a human-readable address from coordinates using a reverse geocoding API.
         * @param {number} lat The latitude.
         * @param {number} lon The longitude.
         * @returns {Promise<string>} A promise that resolves with the address.
         */
        async function getAddressFromCoordinates(lat, lon) {
            // Using OpenStreetMap's free Nominatim API for reverse geocoding
            const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Geocoding API failed with status: ${response.status}`);
                }
                const data = await response.json();
                // The 'display_name' field has the full, formatted address.
                if (data && data.display_name) {
                     // Shorten the address to the first few parts to keep the QR code from getting too complex
                    const addressParts = data.display_name.split(', ');
                    return addressParts.slice(0, 4).join(', ');
                } else {
                    return "Address not found";
                }
            } catch (error) {
                console.error("Reverse geocoding error:", error);
                return "Could not fetch address";
            }
        }

        /**
         * Generates the QR code with address, timestamp, and selected mode.
         */
        async function generateQRCode() {
            let addressString = "NO_ADDRESS";
            
            qrcodeContainer.innerHTML = '';
            locationStatusEl.textContent = '';

            try {
                // 1. Get current location position object
                contentDisplay.textContent = 'Getting location...';
                const position = await getCurrentLocation();
                const { latitude, longitude } = position.coords;

                // 2. Get address from coordinates
                contentDisplay.textContent = 'Fetching address...';
                addressString = await getAddressFromCoordinates(latitude, longitude);
                locationStatusEl.innerHTML = `<span class="text-green-700 font-semibold">✓ Location found</span>`;

            } catch (error) {
                console.error("Error during QR generation:", error);
                locationStatusEl.innerHTML = `<span class="text-yellow-600 font-semibold">⚠️ Location access denied.</span><br><span class="text-xs text-gray-500">Allow location in browser settings and refresh.</span>`;
            }

            // 3. Get current date and format it for India Standard Time (IST)
            const now = new Date();
            const options = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            };
            const timeString = now.toLocaleString('en-IN', options);
            
            // 4. Create the full content string for the QR code, with or without address
            const qrPrefix = `QUALIVON_${currentMode}_`;
            const qrContent = addressString !== "NO_ADDRESS"
                ? qrPrefix + addressString.replace(/ /g, '_').replace(/,/g, '') + "_" + timeString
                : qrPrefix + "NO_LOCATION_" + timeString;

            // 5. Generate the new QR code
            new QRCode(qrcodeContainer, {
                text: qrContent,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // 6. Update the display text for verification
            contentDisplay.textContent = qrContent;

            // 7. Start the visual countdown timer
            startCountdown();
        }

        /**
         * Manages the visual countdown timer and progress bar.
         */
        function startCountdown() {
            if (countdownIntervalId) clearInterval(countdownIntervalId);
            let secondsLeft = UPDATE_INTERVAL_MS / 1000;
            countdownDisplay.textContent = `${UPDATE_INTERVAL_MINUTES}:00`;
            progressBar.style.width = '100%';

            countdownIntervalId = setInterval(() => {
                secondsLeft--;
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                countdownDisplay.textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
                const percentage = (secondsLeft / (UPDATE_INTERVAL_MS / 1000)) * 100;
                progressBar.style.width = `${percentage}%`;
                if (secondsLeft <= 0) clearInterval(countdownIntervalId);
            }, 1000);
        }

        /**
         * Updates the UI and regenerates the QR code when the mode changes.
         * @param {'IN' | 'OUT'} newMode 
         */
        function setMode(newMode) {
            currentMode = newMode;
            if (newMode === 'IN') {
                btnIn.classList.add('btn-active');
                btnIn.classList.remove('btn-inactive');
                btnOut.classList.add('btn-inactive');
                btnOut.classList.remove('btn-active');
            } else {
                btnOut.classList.add('btn-active');
                btnOut.classList.remove('btn-inactive');
                btnIn.classList.add('btn-inactive');
                btnIn.classList.remove('btn-active');
            }
            generateQRCode();
        }

        // --- EVENT LISTENERS ---
        btnIn.addEventListener('click', () => setMode('IN'));
        btnOut.addEventListener('click', () => setMode('OUT'));

        // --- INITIALIZATION ---
        setMode('IN');
        setInterval(generateQRCode, UPDATE_INTERVAL_MS);

    </script>

</body>
</html>

